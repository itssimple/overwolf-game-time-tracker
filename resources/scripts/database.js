function GameTimeTrackerDatabase(){return this.DBInstance=null,this.initializeDatabase=function(e=null){let a=window.indexedDB.open("gameTimeTracker",2);a.onupgradeneeded=function(e){const s=a.result,t=e.target.transaction;if(log("[DB]","Old",e.oldVersion,"New",e.newVersion),e.oldVersion<1){log("[DB]","Creating first version of database, since it never existed on this installation.");const n=s.createObjectStore("gameSessions",{autoIncrement:!0});n.createIndex("by_gameclass","gameClass"),n.createIndex("by_sessionid","sessionId")}e.oldVersion<2&&t.objectStore("gameSessions").createIndex("by_startdate","startDate")},a.onsuccess=function(){log("[DB]","Loaded database"),window.db.DBInstance=a.result,e&&e()}},this.newGameSession=function(e){this.DBInstance.transaction("gameSessions","readwrite").objectStore("gameSessions").add({sessionId:e.sessionId,gameClass:e.classId,gameTitle:e.title,startDate:Date.now(),endDate:null})},this.updateGameSession=function(e,t){this.DBInstance.transaction("gameSessions","readwrite").objectStore("gameSessions").index("by_gameclass").openCursor(IDBKeyRange.only(e.gameInfo.classId),"prev").onsuccess=function(e){e=e.target.result;if(e){if(null==e.value.endDate){const s=e.value;return s.endDate=Date.now(),e.update(s),void(t&&t())}e.continue()}}},this.updateGameSessionBySessionId=function(e,t,n){this.DBInstance.transaction("gameSessions","readwrite").objectStore("gameSessions").index("by_sessionid").openCursor(IDBKeyRange.only(e),"prev").onsuccess=function(e){e=e.target.result;if(e){const s=e.value;t.endDate&&(s.endDate=t.endDate),t.gameClass&&(s.gameClass=t.gameClass),t.gameTitle&&(s.gameTitle=t.gameTitle),t.startDate&&(s.startDate=t.startDate),e.update(s),n&&n()}}},this.getSessions=function(s){let t=[];this.DBInstance.transaction("gameSessions","readonly").objectStore("gameSessions").index("by_startdate").openCursor(null,"prev").onsuccess=function(e){e=e.target.result;e?(t.push(e.value),e.continue()):s(t)}},this.getUnfinishedSessions=function(s){let t=[];this.DBInstance.transaction("gameSessions","readonly").objectStore("gameSessions").index("by_startdate").openCursor(null,"prev").onsuccess=function(e){e=e.target.result;e?(e.value.endDate||t.push(e.value),e.continue()):s(t)}},this}